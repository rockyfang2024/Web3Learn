## 公钥和私钥

“有两类以太坊账户可以用来持有和操作以太币：外部账户和合约账户。外部账户对以太币的所有权是通过私钥、以太坊地址和数字签名建立起来的。私钥乃是用户与以太坊交互的核心。实际上，账户地址直接由私钥推导而来：一个私钥会与唯一一个以太坊地址（也称为账户）挂钩。”

“以太坊系统中没有任何地方直接用到了私钥，私钥也从不会用以太坊网络传输或存储。也就是说，私钥应该保密，既不应该在以太坊网络通信中出现，也不应存储在链上。只有账户地址和数字签名可以在链上传输或存储。”

“资金的访问与控制权都是通过数字签名实现的，而数字签名也是用私钥生成的。”

“所有以太坊交易都要求在链上包含有效的数字签名。任何持有私钥的人都有对该私钥对应的账户及账户资金的控制权。”

“在任何以公钥加密为基础的系统（比如以太坊）中，密钥是成对的，由私钥与公钥组成。我们可以把公钥想象成银行账户，而私钥则是账户密码，前者（公钥，银行账户）用于识别身份，后者（私钥，账户密码）提供对账户的控制权。以太坊用户通常不会直接看到私钥，大部分情况下，私钥以加密形式保存在钱包软件所管理的文件中。”


“公钥密码学（也称为“非对称加密技术”）是现代计算机和信息安全的数学基础。”


“私钥就是一组随机获取的数字。通过私钥实现的所有权和控制是所有用户控制的根本，这包括该以太坊地址下的以太币的控制，以及针对通过这个地址认证的合约的控制。私钥用来生成数字签名，在交易中用于证明对以太币的所有权。私钥必须严格保密，如果私钥泄露给第三方，就相当于给予了他们对这个私钥对应的以太币和合约的完全控制权。私钥也必须备份和妥善保管，防止丢失，如果私钥丢失了，是没有任何办法恢复的，私钥对应的以太币也就被永久锁定了（相当于丢失了）。”

“公钥和钱包的地址可以通过私钥计算后生成。”


“公钥是通过对私钥使用椭圆曲线的乘法运算得来的，而这个乘法运算基本上是不可逆的：K=k*G，其中k是私钥，G是一个常量点，称为生成点，K是计算得来的公钥，*是椭圆曲线函数的乘法运算符号。”

“最方便的以太坊钱包就是单一私钥和对应地址，在每一个场合中都使用同一个地址。但是，这样的解决方案就是隐私上的恶梦，因为任何人都可以轻松跟踪你的交易并将它们关联起来。为每一笔交易都使用一个新私钥对隐私性来说当然是最好的了，但这样就很难管理私钥。最佳平衡点并不容易把握，但这也解释了为什么钱包的设计是最重要的。”

“一个针对以太坊钱包的常见误解是认为钱包中包含以太币或者代币。实际上，钱包中只保存了密钥。以太币和其他各种代币都保存在以太坊区块链上。用户使用钱包中保存的私钥来签名交易，进而控制属于他们的以太币或代币。”

## 确定性钱包和非确定性钱包

“钱包主要分两类，取决于它所保存的密钥之间是否存在关联。
第一类是非确定性钱包，其中保存的每一个私钥都是通过不同的随机数相互独立地生成的。私钥之间没有任何关联。这类钱包被称为JBOK（Just a Bunch Of Keys）钱包。
第二类钱包是确定性钱包，其中所有的密钥都是从一个主密钥衍生而来的，这个主密钥就是种子密钥。这类钱包中所有的密钥之间都存在关联关系，如果获得了“种子密钥”，则可以重新生成所有密钥。确定性钱包有多种密钥派生方法。最常用的派生方法是使用一个类似树形的结构，我们称之为层级式确定性（hierarchical deterministic）钱包，或简称为HD钱包，具体请参见本章“层级式确定性钱包（BIP-32/BIP-44）”一节中的内容。”

“相比随机非确定性钱包，HD钱包有两个主要的好处。首先，树形结构可以用来表示组织结构的含义，例如一组密钥专门用来收款，另外一组专门用来付款。也可以把这样的结构跟公司的组织架构对应，把树形结构的分支跟部门、区域、具体的职能或公司内部的账户分类相匹配。
第二个好处是HD钱包的用户可以创建一系列公钥，这个过程不需要访问对应的私钥。这样就允许HD钱包被用在相对不安全的服务器上，或者专门用于收款，这时候钱包中不需要保存可以操作以太币的私钥信息。”


如果你正在开发实现一款以太坊钱包，那么最好把它做成HD钱包，带有一个经过助记词编码的“种子密钥”用于钱包的备份，并遵循前面列出的这些标准（BIP-32、BIP-39、BIP-43和BIP-44）。

## 交易

交易是唯一能够触发区块链状态改变，或触发EVM上的合约执行的东西。以太坊是一个全局的单体状态机，交易是唯一能够让这台状态机向前推进并改变状态的东西。合约并不会自动运行。以太坊也不会在“后台”运行。所有这一切，都是由交易触发的。

“nonce是发起方地址的一个属性，也就是说它只在发送地址的上下文中才有意义。而且nonce也不会作为账户状态的一部分显式地保存在区块链上。相反，它是通过计算发送方地址已经确认的交易数量而动态计算的。”

“如果包含了随机数，那么你发送的第一笔交易将具有一个随机数，假设是3，而8 ether的交易将具有下一个随机数（如4）。因此，这笔交易 将被忽略，直到nonce值为0到3的交易已经被处理，即便它是先接收到的。”

“值得注意的是，与比特币协议使用的“未花费输出”（UTXO）机制相比，使用随机数对于基于账户的区块链协议实际上是至关重要的。”

### GAS

“gas就是以太坊的燃料。gas并不是以太币，它是一种独立的虚拟货币，跟以太币之间存在汇率关系。以太坊使用gas来控制交易对资源的使用，因为交易会在数以千计的以太坊节点上被处理。开放型（图灵完备）的计算模式需要一种计量单位，以确保避免拒绝服务式攻击或那些过度消耗资源的交易。”

“gas价格的计量单位是wei/gas”

“gasLimit表示这个交易的发起方为了完成交易所愿意支付的最大gas数量。”

“当你发出交易时，验证交易的第一个步骤就是确保发起交易的账户中有足够的以太币来支付对应的gas费用（即gasPrice*gas）。但是这时并不会从账户中直接扣除gas，而是直到交易执行结束后才会扣除。你只会被扣除交易执行所实际发生的gas，但是账户中必须有高于你在交易中指定的最高gas费用对应的以太币，这个交易才能通过验证。”

## 交易接收方

“交易的接收方在to字段中指定。这个字段包含了一个20字节的以太坊地址。这个地址既可以是外部账户，也可以是合约的地址。
以太坊不会进一步验证这个地址。任何一个20字节的值都会被认为是正确的。如果这20字节的值对应的是一个没有私钥的地址，或者没有对应的合约，这个交易仍旧是合法的。以太坊无法判断这个地址是否是从已知的公钥（因而这个地址会有一个可以解锁的私钥）衍生而来的。
”

### 交易中的以太币和数据

“交易数据包的核心是这两个字段：value和data。交易可以同时包括value和data，只有value、只有data或既没有value也没有data这几种情况都是正确且合法的。
只包含value的交易是支付操作。只包含data的交易是针对合约的调用。既没有value也没有data的交易也许只是为了浪费gas，但也是允许的。”

### 特殊交易：合约创建

“区块链上创建新合约的交易，这些合约用于未来有需求的场合。合约注册交易的目的地址是一个特殊的地址——零地址。简单地说，合约注册交易的to字段包含的是0x0。这个地址既不是一个外部账户地址（没有与之对应的私钥或者公钥），也不是一个合约地址。这个地址永远都不能用来支付以太币或者触发交易。它只是作为一个目标，一个带有特殊的“注册合约”含义的目标地址。”

“尽管全零地址仅用来进行合约注册，但有时候这个地址也会收到来自其他账户的以太币转账。对这个情况有两种解释：一种情况是由于误操作，这就导致了以太币的丢失；另一种情况是有意地销毁以太币（故意把以太币发到永远不会花费它的地址）。如果你希望有意地销毁一些以太币，那么需要向网络明确地表示你的意图，使用这个特殊的销毁地址：”


0x000000000000000000000000000000000000dEaD

“合约注册交易中唯一需要的就是在data字段中包含经过编译的合约字节码。这个交易的唯一用处就是把合约注册到以太坊区块链上。你可以在value字段中包含以太币，从而为新的合约设置起始余额，但这完全是可选的。如果你向合约注册地址发送了一笔只有value（以太币）而没有data数据字段的交易，那么这比交易的效果和销毁以太币一样：没有新的合约可用，以太币却丢失了。”

### 数字签名

“以太坊中使用的数字签名称为椭圆曲线数字签名算法，简称ECDSA”

“数字签名是一种数学标准，用于证明某个数字消息或文档的真实性。”

“数字签名的数学标准中包含两个部分。第一部分适用于创建签名的算法，针对一个消息（例如我们的以太坊交易数据包）使用私钥（签名密钥）进行签名。第二部分是一个允许任何人使用消息和公钥进行签名验证的算法。”

“为了生成一个正确的交易，交易的发起方必须在交易的数据包中附带上使用椭圆曲线数字签名算法生成的数字签名。当我们说“对某个交易签名”时，实际上是指“对采用RLP编码的交易数据包的Keccak-256哈希值”进行签名。签名是针对交易数据包的哈希值进行的，而不是针对交易数据包本身。”

“在以太坊中签名一个交易，发起方需要：
1.生成一个交易数据包，包括九个字段：nonce、gasPrice、gasLimit、to、value、data、chainID、0、0。
2.把交易数据包进行RLP格式编码。
3.计算这个交易的Keccak-256哈希值。
4.计算ECDSA签名，使用交易发起方的私钥进行签名。
5.在交易中插入经过ECDSA签名获得的v、r和s的值。
”

“交易消息中并没有包括任何from字段。这是因为交易发起方的公钥可以通过ECDSA的签名计算得到。”

### 交易的传播

“以太坊网络使用“洪泛”路由协议。”

“交易的广播从一个发起以太坊节点的交易创建（或从离线设备接收）和签名开始。”

“交易通过验证后，会传送给所有跟这个发起节点直接相连的以太坊节点。平均而言，每一个以太坊节点大约维护了至少13个跟它直接相连的其他节点，称为邻居。”

“每一个邻居节点都会在收到交易数据包后立刻进行验证。如果它们确认交易数据包是合法的，这些节点就会保留一份交易副本，然后把交易数据包广播给与它们相连的邻居（除去消息来源的那个上游节点）”

“交易就像是水中的波纹一样，在整个网络中迅速传播开，直到所有节点都收到了一份交易的副本。节点可以对所广播的消息进行过滤，但默认情况下，节点会广播收到的所有验证消息。”

### 多签名交易


“以太坊基本的外部账户值交易并没有提供多重签名的功能，但是，任何有关签名的限制都可以通过智能合约来强制执行，包括你能想到的关于交易以太币和其他通证的任何条件。”

“为了利用这种能力，以太币必须被转移到“钱包合约”，该合约对支出规则进行了编程，例如多重签名或者要求支出限额（或者两者的结合）。一旦满足支出条件，钱包合约将在外部账户的授权提示下进行支出。所以，要想在多重条件下保护你的以太币，请将以太币转移到多重签名合约。每当你想将资金发送到另外一个账户时，所有必要的用户都需要通过常规的钱包应用向合约发送交易，从而有效授权合约执行最终的交易。
这些合约还可以被设计为在执行本地代码之前需要多个签名或者触发其他合约。这个方案的安全性最终由多重签名合约的代码所决定。
能够为智能合约实现多重签名的能力证明了以太坊的灵活性。”

“交易是以太坊系统进行每项活动的起点。交易作为“输入”，可以导致以太坊虚拟机执行合约、更新余额以及更改以太坊区块链的状态。”

