### **EVM 的世界状态（World State）是什么？**

在以太坊虚拟机（EVM）中，**世界状态（World State）** 是一个全局的映射，记录了区块链上所有账户的状态以及与这些账户相关的信息。简单来说，它是存储在区块链中的“完整快照”，包含了当前所有与账户（用户地址或智能合约地址）相关的数据。

每当发生交易或智能合约调用时，EVM 会对世界状态进行变化更新。

---

### **EVM 世界状态的核心内容**
#### **1. 世界状态的本质**
- **结构：** 世界状态是一个从账户地址到账户状态的映射。
  - 形式：`worldState[address] = accountState`
  - 每个账户状态描述了账户的余额、存储内容等信息。

#### **2. 账户的类型**
以太坊账户分为两类：
1. **外部账户（EOA, Externally Owned Account）**
   - 由用户实际控制的账户，具有公钥和私钥（比如一个钱包地址）。
   - 特点：
     - 不包含代码。
     - 由用户通过私钥签署交易操作。

2. **合约账户（Contract Account）**
   - 存储智能合约代码，并能被调用。
   - 特点：
     - 账户状态中包含智能合约代码。
     - 通过交易或外部账户调用其函数来执行逻辑。

---

### **世界状态的组成**

每个账户的状态由以下部分组成：

1. **余额（balance）**
   - 链上账户（无论是 EOA 还是合约账户）拥有的以太币（ETH ）数量。
   - 以 256 位整数表示。

2. **随机数（nonce）**
   - 对于 EOA：表示该账户发出的交易次数，用于防止交易重放攻击。
   - 对于合约账户：表示该账户创建的合约数量。

3. **代码哈希（codeHash，合约账户特有）**
   - 合约账户存储的字节码的哈希值。
   - 外部账户的 `codeHash` 为空。
   - 智能合约的核心逻辑通过字节码（bytecode）存储在区块链上。

4. **存储根（storageRoot，合约账户特有）**
   - 定位合约内部的存储内容（存储是一个键值对映射，通常通过 `SSTORE` 和 `SLOAD` 操作来读写）。
   - 存储由梅克尔树（Merkle Patricia Trie）组织，存储根是存储数据的哈希根节点。

---

### **世界状态的存储组织**
世界状态并不是直接记录一个简单的地址映射，而是使用**梅克尔 Patricia Trie (MPT)** 数据结构来存储。该数据结构的几个特点：

1. **渐进式更新：**
   - 世界状态并不频繁完整地更新，而是基于区块中交易的执行结果，对世界状态局部进行修改。

2. **分布式验证：**
   - 通过 Merkle 哈希树的结构，可以高效验证状态在不同节点的正确性。

3. **状态根（State Root）：**
   - 每个区块都有一个状态根（`stateRoot`），它是该区块产生后的世界状态的哈希值。
   - 节点通过这个哈希值验证世界状态是否正确。

---

### **世界状态是如何变化的？**
1. **通过交易变更：**
   - 用户发送交易（如转账、智能合约调用）。
2. **EVM 的状态转换函数：**
   - EVM 根据交易和合约调用的逻辑执行操作，从而使世界状态根据操作进行更新。

举例：
- 用户 A 转账 1 ETH 给用户 B：
  - 世界状态中，A 的账户余额减少 1 ETH，B 的账户余额增加 1 ETH。
- 调用一个合约函数以存储一些数据：
  - 世界状态中更新该合约账户的存储信息。

---

### **世界状态在智能合约中的表现**

在智能合约运行中，EVM 会用到两种存储系统：
1. **内存（Memory）：**
   - 临时数据存储，仅在合约执行期间存在。
   - 执行结束后，内存会被销毁，不影响世界状态。

2. **存储（Storage）：**
   - 世界状态中的一部分。
   - 通过 `SSTORE` 和 `SLOAD` 操作来更新和读取。
   - 每次更新存储都会直接影响世界状态，并消耗大量 Gas（写入存储操作成本高，比如 20,000 Gas）。
   - 通常用于保存持久化数据，比如账户余额或者某些智能合约的关键信息。

---

### **一个简单的智能合约对世界状态的更新示例**

#### **Solidity 代码示例**
```solidity
pragma solidity ^0.8.0;

contract StorageExample {
    uint256 public data;

    function store(uint256 _data) public {
        data = _data; // This updates the world state
    }
}
```

#### **事务执行过程：**
1. 部署合约：
   - 世界状态新增一个合约账户。
   - 合约账户包含字节码以及一个空的存储。
2. 调用 `store(42)`：
   - 世界状态的变化：
     - 修改合约账户的 `data` 存储值为 `42`。
     - 增加交易发起账户的随机数，并扣除相应 Gas 费用。
     - 增加矿工账户 ETH 余额（Gas 费用）。

---

### **总结**
EVM 的**世界状态**是一个核心概念，用来记录区块链上所有账户的完整状态，包括余额、智能合约数据和存储等。通过以下几点加深理解：
1. **组成：** 包括账户地址、余额、随机数、合约代码哈希和存储数据。
2. **数据变更：** 交易和合约操作会通过 EVM 的状态转换函数对世界状态进行修改。
3. **存储模型：** 基于 Merkle Patricia Trie，保证分布式存储的高效和安全。
4. **操作区别：** 内存是临时的，而存储是持久化的信息，直接影响世界状态。

世界状态是以太坊和智能合约执行过程的“快照”，理解它是深入掌握以太坊底层原理的关键一步。


在任何给定的时间，ETH只有一个世界状态。