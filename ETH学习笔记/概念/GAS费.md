以太坊（ETH）有几个不同的货币单位，用于表示以太坊网络中的交易和费用。这些单位是基于最小的以太币单位（称为“wei”），并逐渐增加到更大的单位。以下是以太坊的主要货币单位及其换算关系：

### 以太坊的货币单位

1. **Wei**（韦）
   - **最小单位**: 以太坊的基础单位，所有其他单位都是以 wei 为基础进行换算。
   - **换算**: 1 ETH = 10^18 Wei

2. **Gwei**（戈韦）
   - **常用于表示燃料费用**（gas price），因为它更加易于理解和使用。
   - **换算**: 1 Gwei = 10^9 Wei
   - **换算**: 1 ETH = 1,000,000,000 Gwei

3. **Ada**（艾达）
   - **常在一些小型交易或开发中使用**，但不如 Gwei 和 Wei 常见。
   - **换算**: 1 Ada = 10^6 Wei
   - **换算**: 1 ETH = 1,000,000,000,000 Ada

4. **Mwei**（米韦）
   - **用于表示中等规模的交易费用**，比 Gwei 更小，但比 Wei 更大。
   - **换算**: 1 Mwei = 10^6 Wei
   - **换算**: 1 ETH = 1,000,000 Mwei

5. **Kwei**（千韦）
   - **用于表示更小金额的交易**。
   - **换算**: 1 Kwei = 10^3 Wei
   - **换算**: 1 ETH = 1,000,000,000,000 Kwei

### 换算汇总
| 单位    | 换算为 Wei                   |
|---------|-------------------------------|
| 1 Wei   | 1 Wei                         |
| 1 Kwei  | 10^3 Wei                     |
| 1 Mwei  | 10^6 Wei                     |
| 1 Gwei  | 10^9 Wei                     |
| 1 Ether (ETH) | 10^18 Wei               |

### 示例
- **如果你有 1 Gwei**，那么你可以将其换算为 Wei：  
  1 Gwei = 10^9 Wei = 1,000,000,000 Wei

- **如果你想知道 1 ETH 有多少 Gwei**，那么：  
  1 ETH = 1,000,000,000 Gwei = 1,000,000,000 Gwei

### 总结
这些单位的设计使得以太坊网络能够在处理极小的交易量和费用时保持精确。使用 Wei 和 Gwei 等单位，可以更方便地处理交易费用，特别是在处理高频交易和复杂智能合约时。因此，理解这些货币单位及其换算关系对于以太坊用户和开发者至关重要。


### **1. Gas 的计算方式**

在以太坊中，**Gas** 是执行操作或存储数据所需的计算资源，以此衡量智能合约和交易的成本。计算过程包括以下几部分：

#### **1.1 Gas 计算的基本组成**
- **每种操作（Opcode）都有固定的 Gas 消耗：**
  - 以太坊虚拟机（EVM）中智能合约通过字节码运行，每个指令（Opcode）都会消耗一定量的计算资源。
  - 举例：
    - 简单加法操作（`ADD`）：消耗 3 Gas。
    - 存储一个值到链上（`SSTORE`）：消耗 20,000 Gas。
    - 调用另一个智能合约（`CALL`）：消耗 700 Gas（不含调用的 Gas 消耗）。
- **存储成本较高，计算成本较低：**
  - 存储数据（如 `SSTORE`、`SLOAD`）的成本明显高于计算型指令（如加法、乘法）。

#### **1.2 消耗总 Gas 的计算公式**
一个交易的总 Gas 消耗由以下两部分构成：
1. **基础 Gas（21000 Gas）：**
   - 每笔交易的最低消耗，执行的基本逻辑中包括：
     1. From 地址转移到 To 地址。
     2. 验证签名。
2. **变量 Gas（取决于操作）：**
   - 根据交易数据和操作的复杂性额外消耗的 Gas。
   - 例如：
     - 调用一个合约函数并存储数据。
     - 调用合约中的函数层次结构。

公式如下：  
**总 Gas 消耗 = 基础 Gas + 交易操作消耗 + 存储和计算的额外 Gas**

#### **1.3 示例**
假设某用户发送一笔交易，转移 1 ETH，同时调用一个合约的函数，该函数中存储一个值到状态变量（`SSTORE`）：
- **基础 Gas：** 21000。
- **合约调用 Gas：**
  - 调用一个函数：700。
  - 存储操作（`SSTORE`）：20000。
- **总 Gas 消耗：** 21000 + 700 + 20000 = **41700 Gas**。

---

### **2. 为什么 Gas 会波动？**

Gas 本质上是区块链运行中的计算成本，Gas 费用会波动的原因主要与以下因素有关：

#### **2.1 Gas 价格（Gwei）的变化**
1. **Gas Price 与 Gas 消耗的区别：**
   - Gas 是计算消耗量（固定值，由操作类型决定）。
   - Gas Price 是用户愿意为每单位 Gas 支付的价格，以 Gwei 为单位（1 Gwei = 10⁻⁹ ETH）。

2. **Gas Price 的波动：**
   - 当网络拥堵时，用户为了让交易优先被矿工处理，会主动提高 Gas Price，以激励矿工优先打包其交易。
   - 当网络空闲时，Gas Price 会下降。

3. **动态竞价机制：**
   - 以太坊引入 EIP-1559 后实现了 Base Fee（基础费用）+ Priority Fee（用户小费）的双层定价机制。
     - Base Fee：由网络自动调整（根据拥堵情况动态变化）。
     - Priority Fee：让用户可以为矿工支付额外的小费。
   - Base Fee 高低直接影响交易成本的波动。

---

#### **2.2 交易复杂性**
1. **合约操作复杂度：**
   - 如果用户的交易涉及复杂的智能合约交互，会消耗更多 Gas。
   - 合约逻辑、存储读写操作，或调用多个子合约函数都会影响交易所需 Gas 的消耗。
2. **交易数据大小：**
   - 数据打包越多，使用 Gas 越高。
   - EVM 对大数据处理需要更多 Gas 资源。

---

#### **2.3 区块 Gas 限额**
1. **每个区块有最大 GasLimit：**
   - 每个区块只能处理有限的 Gas 消耗（目前约 30M Gas）。
   - 如果交易过多，区块达到上限后未被打包的交易会形成拥堵，导致用户提高 Gas Price。

2. **网络拥堵时 Gas 波动更严重：**
   - 像 NFT 热潮（2021 年的 CryptoPunks、Bored Ape 开放 Mint）或流行 DeFi 项目（如 Uniswap 火热时）的出现，用户大量抢占交易，天然会推高 Gas 费用。

---

### **3. 如何创建 Gas 高效的智能合约**

为了尽量降低 Gas 消耗，在智能合约开发中，可以采取以下策略：

#### **3.1 优化存储**
1. **减少链上的存储操作（尽量少用 `SSTORE`）：**
   - 每次写入或修改链上存储数据（`SSTORE`）消耗 20,000 Gas。
   - 尽量减少存储状态变量的次数，例如：
     - 在内存中处理数据，然后一次性保存。
     - 尽可能使用事件（`emit` Event）记录变化，而非状态变量。

2. **用 `struct` 合理打包变量：**
   - 合约中的变量按 256 位对齐（32 字节长度）。
   - 将小变量（如 `uint8`、`bool`）组合到 `struct` 中以优化存储。
     ```solidity
     struct Example {
         uint8 status;   // 1 byte
         bool isActive;  // 1 byte
     }
     ```

3. **清理存储变量：**
   - 如果不再需要某些状态变量，可以将它们清零（`SSTORE` 清理为 0，只消耗 5,000 Gas）。

---

#### **3.2 避免不必要的计算**
1. **尽量减少循环次数：**
   - 循环消耗 Gas，避免在区块 Gas 限制内超时失败。
   - 在外部预处理数据，避免在合约中执行过于复杂的循环。

2. **优化复杂函数逻辑：**
   - 将频繁调用的逻辑封装成库（Library），减少重复代码。
   - 使用 `internal` 函数优化 Gas，而非 `public` 或 `external`。

---

#### **3.3 合理选择数据类型**
1. **使用更具体的数据类型：**
   - 比如将 `uint256` 替换为 `uint8`、`uint16` 等，减少存储成本。
   - 避免使用动态类型如 `string` 和 `array`，尽量使用定长类型。

2. **避免 `abi.encode` 和 `abi.encodePacked` 的过多使用：**
   - 编码操作对复杂数据处理的 Gas 消耗较高，可以避免不必要的编码。

---

#### **3.4 合约架构优化**
1. **使用 `view` 或 `pure` 函数：**
   - 查看数据（`view`）或纯粹计算（`pure`）函数不进行存储修改，因此消耗更少的 Gas。
     ```solidity
     function getSum(uint a, uint b) public pure returns (uint) {
         return a + b;
     }
     ```

2. **避免频繁调用合约：**
   - 合约调用其他合约时会消耗额外 Gas，减少外部调用次数。
   - 使用 `delegatecall` 时保持逻辑简单，避免安全风险。

---

#### **3.5 使用代码优化工具**
1. **工具推荐：**
   - **Solhint** 或 **Solidity Visual Auditor**：检查代码质量。
   - **Remix Gas Profiler** 或 **Hardhat Gas Reporter**：生成 Gas 消耗报告并优化代码。

2. **检查第三方依赖：**
   - 使用第三方库（如 OpenZeppelin）的情况下，移除未使用的模块，减少不必要的代码。

---

### **总结**
1. **Gas 计算：**
   - Gas = 交易基础费用（21000）+ 操作和存储消耗。
2. **Gas 波动：**
   - 网络拥堵、Base Fee（EIP-1559）和交易复杂度是主要原因。
3. **创建 Gas 高效合约：**
   - 合理优化存储。
   - 简化逻辑，减少循环和存储操作。
   - 掌握工具来优化和调试代码。

通过这些方法，可以显著降低 Gas 消耗，使得合约更高效，同时减少用户交互成本，提升用户体验。